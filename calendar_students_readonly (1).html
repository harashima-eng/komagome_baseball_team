<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>野球部予定表｜閲覧専用カレンダー（Day / Week / Month）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-soft: #e5e7eb;
      --bg-card: #ffffff;
      --bg-card-soft: #f9fafb;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.06);
      --accent-strong: #1d4ed8;
      --text-main: #111827;
      --text-soft: #6b7280;
      --border-soft: #d1d5db;
      --danger: #dc2626;
      --danger-soft: rgba(220, 38, 38, 0.08);
      --today-bg: rgba(34, 197, 94, 0.12);
      --today-border: #16a34a;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.15);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
      --transition-fast: 160ms ease-out;
      --transition-med: 200ms ease-out;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #e5e7eb 0, #ffffff 55%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 18px;
      transition: background var(--transition-med), color 180ms ease-out;
    }

    .app-shell {
      width: 100%;
      max-width: 1220px;
      background: linear-gradient(145deg, rgba(249, 250, 251, 0.98), rgba(229, 231, 235, 0.98));
      border-radius: 26px;
      border: 1px solid rgba(209, 213, 219, 0.95);
      box-shadow: var(--shadow-soft);
      padding: 18px 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title-main {
      font-size: 1.2rem;
      font-weight: 650;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-tag {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-strong);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .title-sub {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #ffffff;
      color: var(--text-main);
      padding: 6px 12px;
      font-size: 0.76rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast), transform 120ms ease-out, box-shadow 120ms ease-out, color 120ms ease-out;
      box-shadow: 0 0 0 rgba(15, 23, 42, 0);
      white-space: nowrap;
    }

    .btn:hover {
      border-color: var(--accent-strong);
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.16), #ffffff);
      box-shadow: 0 5px 14px rgba(148, 163, 184, 0.55);
    }

    .btn-ghost {
      background: transparent;
      border-style: dashed;
    }

    .btn-icon {
      padding: 6px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      min-width: 32px;
      justify-content: center;
    }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      padding: 8px 10px;
      border-radius: 16px;
      background: linear-gradient(145deg, rgba(249, 250, 251, 0.97), rgba(229, 231, 235, 0.96));
      border: 1px solid rgba(209, 213, 219, 0.9);
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .date-label {
      font-size: 0.9rem;
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid rgba(209, 213, 219, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .date-label span.secondary {
      font-size: 0.7rem;
      color: var(--text-soft);
      font-weight: 400;
    }

    .chip-group {
      display: inline-flex;
      padding: 2px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.96);
      border: 1px solid rgba(209, 213, 219, 0.9);
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.78rem;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-soft);
      transition: background var(--transition-fast), color var(--transition-fast), transform 120ms ease-out;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chip.active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
      transform: translateY(-0.5px);
    }

    .chip span.dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-strong);
    }

    .calendar-shell {
      border-radius: 18px;
      background: linear-gradient(145deg, rgba(249, 250, 251, 0.97), rgba(229, 231, 235, 0.96));
      border: 1px solid rgba(209, 213, 219, 0.9);
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 430px;
      max-height: 72vh;
    }

    .weekdays-row {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      padding-inline: 2px;
      padding-bottom: 2px;
      font-size: 0.74rem;
      color: var(--text-soft);
    }

    .weekdays-row span {
      text-align: center;
      padding: 4px 0;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
    }

    .weekdays-row span.sun {
      color: #fb7185;
    }

    .weekdays-row span.sat {
      color: #60a5fa;
    }

    .calendar-grid-month {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      grid-auto-rows: minmax(78px, 1fr);
      gap: 4px;
      overflow: hidden;
    }

    .calendar-cell {
      position: relative;
      border-radius: 14px;
      padding: 6px 6px 4px;
      background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.98), rgba(243, 244, 246, 0.98));
      border: 1px solid rgba(209, 213, 219, 0.9);
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow: hidden;
      cursor: default;
      transition: border-color var(--transition-fast), background var(--transition-fast), transform 120ms ease-out, box-shadow 120ms ease-out;
    }

    .calendar-cell.muted {
      opacity: 0.55;
      background: radial-gradient(circle at bottom right, rgba(248, 250, 252, 0.98), rgba(226, 232, 240, 0.98));
    }

    .calendar-cell.today {
      background: radial-gradient(circle at top left, var(--today-bg), rgba(249, 250, 251, 0.98));
      border-color: var(--today-border);
    }

    .date-chip {
      display: inline-flex;
      align-items: baseline;
      gap: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .date-chip span.main-date {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.98);
      border: 1px solid rgba(209, 213, 219, 0.9);
    }

    .date-chip span.weekday {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .events-list {
      margin-top: 2px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      overflow-y: auto;
      padding-right: 2px;
      scrollbar-width: thin;
    }

    .events-list::-webkit-scrollbar {
      width: 5px;
    }

    .events-list::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }

    .event-pill {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 0.7rem;
      background: rgba(37, 99, 235, 0.12);
      border: 1px solid rgba(129, 140, 248, 0.7);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      min-height: 18px;
    }

    .event-pill span.time {
      font-variant-numeric: tabular-nums;
      opacity: 0.9;
    }

    .event-pill span.title {
      flex: 1;
      min-width: 0;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .event-pill.practice {
      background: rgba(22, 163, 74, 0.16);
      border-color: rgba(34, 197, 94, 0.8);
    }

    .event-pill.game {
      background: rgba(248, 113, 113, 0.16);
      border-color: rgba(248, 113, 113, 0.9);
    }

    .event-pill.other {
      background: rgba(56, 189, 248, 0.14);
      border-color: rgba(56, 189, 248, 0.9);
    }

    .calendar-week {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow: hidden;
    }

    .calendar-week-header {
      display: grid;
      grid-template-columns: 64px repeat(7, minmax(0, 1fr));
      gap: 4px;
      font-size: 0.74rem;
      color: var(--text-soft);
      padding-inline: 2px;
    }

    .calendar-week-header div {
      text-align: center;
      padding: 4px 0;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.96);
    }

    .calendar-week-body {
      flex: 1;
      display: grid;
      grid-template-columns: 64px repeat(7, minmax(0, 1fr));
      gap: 4px;
      overflow-y: auto;
    }

    .time-col {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.7rem;
      color: var(--text-soft);
      padding-top: 2px;
    }

    .time-slot-label {
      height: 32px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      padding-right: 4px;
      font-variant-numeric: tabular-nums;
    }

    .day-col {
      border-radius: 14px;
      background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.98), rgba(243, 244, 246, 0.98));
      border: 1px solid rgba(209, 213, 219, 0.9);
      display: flex;
      flex-direction: column;
      padding: 4px;
      gap: 3px;
      min-height: 100%;
      cursor: default;
    }

    .day-col-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.76rem;
      margin-bottom: 2px;
    }

    .day-col-header span.date {
      font-weight: 600;
    }

    .day-col-header span.weekday {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .day-col-events {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
      overflow-y: auto;
      padding-right: 2px;
      scrollbar-width: thin;
    }

    .day-col-events::-webkit-scrollbar {
      width: 5px;
    }

    .day-col-events::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }

    .calendar-day-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
    }

    .calendar-day-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      font-size: 0.9rem;
    }

    .calendar-day-header .date-main {
      font-size: 1.05rem;
      font-weight: 650;
      padding: 4px 10px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid rgba(209, 213, 219, 0.9);
    }

    .calendar-day-header .date-sub {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .calendar-day-events {
      flex: 1;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.99), rgba(243, 244, 246, 0.98));
      border: 1px solid rgba(209, 213, 219, 0.9);
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow-y: auto;
    }

    .calendar-day-events .no-events {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .event-card {
      border-radius: 12px;
      padding: 6px 8px;
      font-size: 0.78rem;
      background: #ffffff;
      border: 1px solid rgba(209, 213, 219, 0.95);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .event-card-header {
      display: flex;
      align-items: baseline;
      gap: 6px;
      justify-content: space-between;
    }

    .event-card-title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge-type {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.65rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .badge-type.practice {
      background: rgba(34, 197, 94, 0.18);
      color: #166534;
      border: 1px solid rgba(22, 163, 74, 0.9);
    }

    .badge-type.game {
      background: rgba(248, 113, 113, 0.2);
      color: #b91c1c;
      border: 1px solid rgba(248, 113, 113, 0.95);
    }

    .badge-type.other {
      background: rgba(56, 189, 248, 0.2);
      color: #075985;
      border: 1px solid rgba(56, 189, 248, 0.9);
    }

    .event-card-time {
      font-size: 0.74rem;
      color: var(--text-soft);
      font-variant-numeric: tabular-nums;
    }

    .event-card-notes {
      font-size: 0.74rem;
      color: var(--text-main);
    }

    .calendar-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 2px;
      font-size: 0.7rem;
      color: var(--text-soft);
      flex-wrap: wrap;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid rgba(209, 213, 219, 0.9);
    }

    .legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .legend-swatch.practice {
      background: rgba(34, 197, 94, 0.9);
    }

    .legend-swatch.game {
      background: rgba(248, 113, 113, 0.95);
    }

    .legend-swatch.other {
      background: rgba(56, 189, 248, 0.95);
    }

    .last-updated {
      font-size: 0.7rem;
      color: var(--text-soft);
      text-align: right;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 10px;
      transform: translateX(-50%) translateY(20px);
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(17, 24, 39, 0.98);
      border: 1px solid rgba(55, 65, 81, 0.95);
      color: #e5e7eb;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 6px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease-out, transform 160ms ease-out;
      z-index: 60;
    }

    .toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }

    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .toolbar-left,
      .toolbar-right {
        justify-content: space-between;
      }

      .calendar-week-header,
      .calendar-week-body {
        grid-template-columns: 42px repeat(7, minmax(0, 1fr));
      }

      .time-col {
        font-size: 0.68rem;
      }
    }

    @media (max-width: 640px) {
      .header-row {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="header-row">
      <div class="title-block">
        <div class="title-main">
          野球部予定表
          <span class="title-tag">Students View｜閲覧専用</span>
        </div>
        <div class="title-sub">
          日 / 週 / 月 表示を切り替えて、野球部の予定を確認できます。ここから予定の編集はできません。
        </div>
      </div>
      <div class="header-actions">
        <button id="downloadHtmlBtn" class="btn btn-ghost" type="button">
          ⬇️ Download HTML
        </button>
      </div>
    </div>

    <div class="toolbar">
      <div class="toolbar-left">
        <button id="prevBtn" class="btn btn-icon" type="button">←</button>
        <button id="todayBtn" class="btn btn-ghost" type="button">Today</button>
        <button id="nextBtn" class="btn btn-icon" type="button">→</button>
        <div class="date-label">
          <span id="dateLabelMain"></span>
          <span id="dateLabelSub" class="secondary"></span>
        </div>
      </div>
      <div class="toolbar-right">
        <div class="chip-group" aria-label="View mode">
          <button type="button" class="chip active" data-view="month">
            <span class="dot"></span> Month
          </button>
          <button type="button" class="chip" data-view="week">
            Week
          </button>
          <button type="button" class="chip" data-view="day">
            Day
          </button>
        </div>
      </div>
    </div>

    <div class="calendar-shell">
      <div id="calendarWeekdays" class="weekdays-row" aria-hidden="true"></div>
      <div id="calendarContent"></div>
      <div class="calendar-footer">
        <div class="legend">
          <div class="legend-item">
            <span class="legend-swatch practice"></span>
            <span>Practice</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch game"></span>
            <span>Game</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch other"></span>
            <span>Other / Meeting</span>
          </div>
        </div>
        <div class="last-updated" id="lastUpdated"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">
    <span id="toastText"></span>
  </div>

  <script>
    (function () {
      // NOTE: この閲覧専用版は localStorage から同じ KEY のデータを読み込みます。
      // コーチ用（編集版）の HTML を同じブラウザで開いて保存すると、
      // そのデータがここにも反映されます（同じ PC / 同じブラウザの場合）。
      const STORAGE_KEY = "yb_calendar_events_v1";
      const UPDATED_KEY = STORAGE_KEY + "_updated_at";

      const weekdayLabels = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
      const weekdayLabelsJP = ["月", "火", "水", "木", "金", "土", "日"];

      let currentView = "month";
      let currentDate = new Date();
      let events = loadEvents();

      const calendarContentEl = document.getElementById("calendarContent");
      const calendarWeekdaysEl = document.getElementById("calendarWeekdays");
      const dateLabelMainEl = document.getElementById("dateLabelMain");
      const dateLabelSubEl = document.getElementById("dateLabelSub");
      const lastUpdatedEl = document.getElementById("lastUpdated");

      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const todayBtn = document.getElementById("todayBtn");
      const chipButtons = document.querySelectorAll(".chip-group .chip");
      const toastEl = document.getElementById("toast");
      const toastTextEl = document.getElementById("toastText");
      const downloadHtmlBtn = document.getElementById("downloadHtmlBtn");

      renderWeekdayHeader();
      renderAll();

      prevBtn.addEventListener("click", () => {
        if (currentView === "month") {
          currentDate.setMonth(currentDate.getMonth() - 1);
        } else if (currentView === "week") {
          currentDate.setDate(currentDate.getDate() - 7);
        } else {
          currentDate.setDate(currentDate.getDate() - 1);
        }
        renderAll();
      });

      nextBtn.addEventListener("click", () => {
        if (currentView === "month") {
          currentDate.setMonth(currentDate.getMonth() + 1);
        } else if (currentView === "week") {
          currentDate.setDate(currentDate.getDate() + 7);
        } else {
          currentDate.setDate(currentDate.getDate() + 1);
        }
        renderAll();
      });

      todayBtn.addEventListener("click", () => {
        currentDate = new Date();
        renderAll();
      });

      chipButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          chipButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentView = btn.getAttribute("data-view");
          renderAll();
        });
      });

      downloadHtmlBtn.addEventListener("click", () => {
        const html = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
        const blob = new Blob([html], { type: "text/html;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "calendar_students_readonly.html";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("HTML ファイルをダウンロードしました。");
      });

      function renderAll() {
        renderHeader();
        renderView();
        renderLastUpdated();
      }

      function renderHeader() {
        const y = currentDate.getFullYear();
        const m = currentDate.getMonth() + 1;

        if (currentView === "month") {
          dateLabelMainEl.textContent = y + "年 " + m + "月";
          dateLabelSubEl.textContent = "月間カレンダー";
        } else if (currentView === "week") {
          const range = getWeekRange(currentDate);
          const start = range.start;
          const end = range.end;
          dateLabelMainEl.textContent =
            start.getFullYear() +
            "/" +
            pad(start.getMonth() + 1) +
            "/" +
            pad(start.getDate()) +
            " 〜 " +
            end.getFullYear() +
            "/" +
            pad(end.getMonth() + 1) +
            "/" +
            pad(end.getDate());
          dateLabelSubEl.textContent = "週間カレンダー";
        } else {
          dateLabelMainEl.textContent =
            y + "/" + pad(m) + "/" + pad(currentDate.getDate());
          dateLabelSubEl.textContent =
            weekdayLabelsJP[currentDate.getDay() === 0 ? 6 : currentDate.getDay() - 1] + "曜日（1日表示）";
        }
      }

      function renderView() {
        calendarContentEl.innerHTML = "";
        if (currentView === "month") {
          calendarWeekdaysEl.style.display = "grid";
          renderMonthView();
        } else if (currentView === "week") {
          calendarWeekdaysEl.style.display = "none";
          renderWeekView();
        } else {
          calendarWeekdaysEl.style.display = "none";
          renderDayView();
        }
      }

      function renderWeekdayHeader() {
        calendarWeekdaysEl.innerHTML = "";
        const jp = ["月", "火", "水", "木", "金", "土", "日"];
        jp.forEach((label, idx) => {
          const span = document.createElement("span");
          span.textContent = label;
          if (idx === 5) span.classList.add("sat");
          if (idx === 6) span.classList.add("sun");
          calendarWeekdaysEl.appendChild(span);
        });
      }

      function renderMonthView() {
        const grid = document.createElement("div");
        grid.className = "calendar-grid-month";

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);

        const start = startOfWeek(firstDayOfMonth);
        const end = endOfWeek(lastDayOfMonth);

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const date = new Date(d);
          const cell = document.createElement("div");
          cell.className = "calendar-cell";

          if (date.getMonth() !== month) {
            cell.classList.add("muted");
          }

          const dateNoTime = new Date(date);
          dateNoTime.setHours(0, 0, 0, 0);
          if (dateNoTime.getTime() === today.getTime()) {
            cell.classList.add("today");
          }

          const dateChip = document.createElement("div");
          dateChip.className = "date-chip";
          const mainDateSpan = document.createElement("span");
          mainDateSpan.className = "main-date";
          mainDateSpan.textContent = date.getDate();
          const weekdaySpan = document.createElement("span");
          weekdaySpan.className = "weekday";
          weekdaySpan.textContent = weekdayLabelsJP[(date.getDay() + 6) % 7];

          dateChip.appendChild(mainDateSpan);
          dateChip.appendChild(weekdaySpan);
          cell.appendChild(dateChip);

          const eventsList = document.createElement("div");
          eventsList.className = "events-list";

          const dateKey = toDateKey(date);
          const dayEvents = events
            .filter(ev => ev.date === dateKey)
            .sort(compareEventsByTimeThenType);

          dayEvents.forEach(ev => {
            const pill = document.createElement("div");
            pill.className = "event-pill " + (ev.type || "other");
            const timeSpan = document.createElement("span");
            timeSpan.className = "time";
            timeSpan.textContent = formatTimeRangeShort(ev.start, ev.end);
            const titleSpan = document.createElement("span");
            titleSpan.className = "title";
            titleSpan.textContent = ev.title;

            pill.appendChild(timeSpan);
            pill.appendChild(titleSpan);
            eventsList.appendChild(pill);
          });

          cell.appendChild(eventsList);
          grid.appendChild(cell);
        }

        calendarContentEl.appendChild(grid);
      }

      function renderWeekView() {
        const wrapper = document.createElement("div");
        wrapper.className = "calendar-week";

        const header = document.createElement("div");
        header.className = "calendar-week-header";

        const blank = document.createElement("div");
        blank.textContent = "";
        header.appendChild(blank);

        const range = getWeekRange(currentDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let d = new Date(range.start); d <= range.end; d.setDate(d.getDate() + 1)) {
          const colHeader = document.createElement("div");
          const tmp = new Date(d);
          const dateNoTime = new Date(tmp);
          dateNoTime.setHours(0, 0, 0, 0);
          const isToday = dateNoTime.getTime() === today.getTime();
          colHeader.textContent =
            (tmp.getMonth() + 1) + "/" + tmp.getDate() + " (" +
            weekdayLabelsJP[(tmp.getDay() + 6) % 7] + ")";
          if (isToday) {
            colHeader.style.border = "1px solid " + getComputedStyle(document.body).getPropertyValue("--today-border").trim();
          }
          header.appendChild(colHeader);
        }

        wrapper.appendChild(header);

        const body = document.createElement("div");
        body.className = "calendar-week-body";

        const timeCol = document.createElement("div");
        timeCol.className = "time-col";
        const hours = [6, 9, 12, 15, 18, 21];
        hours.forEach(h => {
          const label = document.createElement("div");
          label.className = "time-slot-label";
          label.textContent = pad(h) + ":00";
          timeCol.appendChild(label);
        });
        body.appendChild(timeCol);

        for (let d = new Date(range.start); d <= range.end; d.setDate(d.getDate() + 1)) {
          const colDate = new Date(d);
          const dayCol = document.createElement("div");
          dayCol.className = "day-col";

          const todayCheck = new Date(colDate);
          todayCheck.setHours(0, 0, 0, 0);
          const isToday = todayCheck.getTime() === (new Date(new Date().setHours(0, 0, 0, 0))).getTime();
          if (isToday) {
            dayCol.style.outline = "1px solid " + getComputedStyle(document.body).getPropertyValue("--today-border").trim();
          }

          const headerRow = document.createElement("div");
          headerRow.className = "day-col-header";
          const dateSpan = document.createElement("span");
          dateSpan.className = "date";
          dateSpan.textContent = (colDate.getMonth() + 1) + "/" + colDate.getDate();
          const weekdaySpan = document.createElement("span");
          weekdaySpan.className = "weekday";
          weekdaySpan.textContent = weekdayLabels[(colDate.getDay() + 6) % 7];
          headerRow.appendChild(dateSpan);
          headerRow.appendChild(weekdaySpan);
          dayCol.appendChild(headerRow);

          const eventsHolder = document.createElement("div");
          eventsHolder.className = "day-col-events";
          const dateKey = toDateKey(colDate);
          const dayEvents = events
            .filter(ev => ev.date === dateKey)
            .sort(compareEventsByTimeThenType);

          dayEvents.forEach(ev => {
            const pill = document.createElement("div");
            pill.className = "event-pill " + (ev.type || "other");
            const timeSpan = document.createElement("span");
            timeSpan.className = "time";
            timeSpan.textContent = formatTimeRangeShort(ev.start, ev.end);
            const titleSpan = document.createElement("span");
            titleSpan.className = "title";
            titleSpan.textContent = ev.title;
            pill.appendChild(timeSpan);
            pill.appendChild(titleSpan);
            eventsHolder.appendChild(pill);
          });

          dayCol.appendChild(eventsHolder);
          body.appendChild(dayCol);
        }

        wrapper.appendChild(body);
        calendarContentEl.appendChild(wrapper);
      }

      function renderDayView() {
        const wrapper = document.createElement("div");
        wrapper.className = "calendar-day-view";

        const header = document.createElement("div");
        header.className = "calendar-day-header";

        const dateMain = document.createElement("div");
        dateMain.className = "date-main";
        dateMain.textContent =
          currentDate.getFullYear() + "/" +
          pad(currentDate.getMonth() + 1) + "/" +
          pad(currentDate.getDate());

        const dateSub = document.createElement("div");
        dateSub.className = "date-sub";
        const wdIndex = (currentDate.getDay() + 6) % 7;
        dateSub.textContent = weekdayLabelsJP[wdIndex] + "曜日 | 1日表示";

        header.appendChild(dateMain);
        header.appendChild(dateSub);
        wrapper.appendChild(header);

        const eventsBox = document.createElement("div");
        eventsBox.className = "calendar-day-events";

        const dateKey = toDateKey(currentDate);
        const dayEvents = events
          .filter(ev => ev.date === dateKey)
          .sort(compareEventsByTimeThenType);

        if (dayEvents.length === 0) {
          const empty = document.createElement("div");
          empty.className = "no-events";
          empty.textContent = "この日の予定は登録されていません。";
          eventsBox.appendChild(empty);
        } else {
          dayEvents.forEach(ev => {
            const card = document.createElement("div");
            card.className = "event-card";

            const headerRow = document.createElement("div");
            headerRow.className = "event-card-header";

            const titleWrap = document.createElement("div");
            titleWrap.className = "event-card-title";
            const titleSpan = document.createElement("span");
            titleSpan.textContent = ev.title;

            const badge = document.createElement("span");
            const type = ev.type || "other";
            badge.className = "badge-type " + type;
            badge.textContent =
              type === "practice" ? "Practice" :
              type === "game" ? "Game" :
              "Other";

            titleWrap.appendChild(titleSpan);
            titleWrap.appendChild(badge);
            headerRow.appendChild(titleWrap);

            const timeSpan = document.createElement("div");
            timeSpan.className = "event-card-time";
            timeSpan.textContent = formatTimeRange(ev.start, ev.end);
            headerRow.appendChild(timeSpan);

            const notes = document.createElement("div");
            notes.className = "event-card-notes";
            notes.textContent = ev.notes || "";

            card.appendChild(headerRow);
            if (ev.start || ev.end) {
              card.appendChild(timeSpan);
            }
            if (ev.notes) {
              card.appendChild(notes);
            }

            eventsBox.appendChild(card);
          });
        }

        wrapper.appendChild(eventsBox);
        calendarContentEl.appendChild(wrapper);
      }

      function renderLastUpdated() {
        const last = localStorage.getItem(UPDATED_KEY);
        if (!last) {
          lastUpdatedEl.textContent = "コーチ側でまだ保存されていません";
          return;
        }
        lastUpdatedEl.textContent = "Last saved (Coach): " + last;
      }

      function loadEvents() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed;
        } catch (e) {
          console.error("Failed to load events", e);
          return [];
        }
      }

      function startOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = (day === 0 ? -6 : 1) - day;
        d.setDate(d.getDate() + diff);
        d.setHours(0, 0, 0, 0);
        return d;
      }

      function endOfWeek(date) {
        const start = startOfWeek(date);
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        end.setHours(23, 59, 59, 999);
        return end;
      }

      function getWeekRange(date) {
        const start = startOfWeek(date);
        const end = endOfWeek(date);
        return { start, end };
      }

      function toDateKey(date) {
        const d = new Date(date);
        return d.getFullYear() + "-" + pad(d.getMonth() + 1) + "-" + pad(d.getDate());
      }

      function pad(n) {
        return n.toString().padStart(2, "0");
      }

      function compareEventsByTimeThenType(a, b) {
        const at = a.start || "";
        const bt = b.start || "";
        if (at && bt && at !== bt) {
          return at < bt ? -1 : 1;
        }
        const typeOrder = { game: 0, practice: 1, other: 2 };
        const ao = typeOrder[a.type] ?? 3;
        const bo = typeOrder[b.type] ?? 3;
        return ao - bo;
      }

      function formatTimeRangeShort(start, end) {
        if (!start && !end) return "All day";
        if (start && !end) return start;
        if (!start && end) return "〜" + end;
        return start + "–" + end;
      }

      function formatTimeRange(start, end) {
        if (!start && !end) return "All day / 終日";
        if (start && !end) return start + " 〜";
        if (!start && end) return "〜 " + end;
        return start + " 〜 " + end;
      }

      function showToast(message) {
        toastTextEl.textContent = message;
        toastEl.classList.add("show");
        setTimeout(() => {
          toastEl.classList.remove("show");
        }, 1800);
      }
    })();
  </script>
</body>
</html>
